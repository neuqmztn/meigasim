ğŸ“˜ MAC Simulator ä½¿ç”¨è¯´æ˜ï¼ˆREADME.mdï¼‰
1. åŠŸèƒ½æè¿°ï¼ˆFunction Overviewï¼‰

mac_simulator.py æ˜¯ä¸€ä¸ªä¸“é—¨ç”¨äº Transformer åŠ é€Ÿå™¨é¡¹ç›®çš„
ç»“æ„çº§ï¼ˆStructural-Levelï¼‰ + å‘¨æœŸçº§ï¼ˆCycle-Levelï¼‰ ä¼°è®¡å™¨ã€‚

å®ƒåŸºäº Synopsys Design Compilerï¼ˆDCï¼‰å¯¹ coordinated_skip_mac_unit ç»¼åˆåçš„
çœŸå®å·¥è‰ºç‰¹æ€§ï¼ˆé¢ç§¯ / åŠ¨æ€åŠŸè€— / æ¼ç”µ / æ—¶é’Ÿå»¶è¿Ÿï¼‰ï¼Œ
ç”¨äºåœ¨ç³»ç»Ÿå±‚é¢è¯„ä¼°ï¼š

âœ” å•é¢— MAC çš„æ€§èƒ½ä¸åŠŸè€—

é¢ç§¯ï¼ˆAreaï¼‰

åŠ¨æ€èƒ½é‡ï¼ˆDynamic Energyï¼‰

æ¼ç”µèƒ½é‡ï¼ˆLeakage Energyï¼‰

å¹³å‡åŠ¨æ€ / æ€»åŠŸè€—

âœ” Skip-Gating ç¨€ç–è¡Œä¸ºçš„èƒ½è€—å½±å“

æŒ‡å®šç¨€ç–åº¦ï¼ˆactive_ratioï¼‰å¯è‡ªåŠ¨ç¼©æ”¾èƒ½é‡

æŒ‡å®šç¿»è½¬ç‡ï¼ˆpp_activity_scaleï¼‰æ¨¡æ‹Ÿä½å¯†åº¦è¾“å…¥

âœ” Pipeline çº§åˆ«çš„æ—¶åºä¸è°ƒåº¦

è¾“å‡ºæ€»å‘¨æœŸæ•°ï¼ˆTotal Cyclesï¼‰

æµæ°´çº¿å»¶è¿Ÿï¼ˆPipeline Latencyï¼‰

æ¯æ‹ pipeline çŠ¶æ€ï¼ˆtrace_pipeline_scheduleï¼‰

âœ” å­æ¨¡å—èƒ½è€—æ¯”ä¾‹ï¼ˆBooth / PP Generator / Sum Tree / Skip Detectorï¼‰

ç”¨äºåç»­è®ºæ–‡ç»˜å›¾ã€æ¨¡å—çº§ profilingã€‚

2. ä½¿ç”¨æ–¹æ³•ï¼ˆHow to Useï¼‰
2.1 å¼•å…¥æ¨¡å—

å°† mac_simulator.py æ”¾åœ¨ä½ çš„å·¥ç¨‹æ ¹ç›®å½•æˆ– Python æœç´¢è·¯å¾„ä¸­ï¼š

from mac_simulator import (
    CoordinatedSkipMacSimulator,
    MacActivityConfig,
)

2.2 åˆ›å»º MAC ä»¿çœŸå™¨å®ä¾‹
mac = CoordinatedSkipMacSimulator()


é»˜è®¤ä¼šåŠ è½½åŸºäº DCï¼ˆtcbn45gsbwp12ttc_ccsï¼‰çš„æŠ€æœ¯å‚æ•°ï¼š

é¢ç§¯ï¼š2979.51

åŠ¨æ€åŠŸè€—ï¼š60.58 ÂµW

æ¼ç”µåŠŸè€—ï¼š47.87 ÂµW

æ—¶é’Ÿï¼š500 MHzï¼ˆå‘¨æœŸ 2nsï¼‰

2.3 æ‰§è¡Œä¸€æ¬¡ MAC èƒ½é‡ä»¿çœŸ
num_ops = 1000   # ä¾‹å¦‚ QK^T ä¸­æœ‰ 1000 æ¬¡ MAC è¿ç®—

activity = MacActivityConfig(
    mac_active_ratio=0.4,    # 40% çš„å‘¨æœŸä¸­æœ‰è®¡ç®—ï¼ˆç¨€ç–/skipï¼‰
    pp_activity_scale=0.6    # æ´»è·ƒå‘¨æœŸå†…ï¼Œç¿»è½¬ç‡ä¸º 60%
)

result = mac.simulate(num_ops, activity)

2.4 æŸ¥çœ‹ä»¿çœŸç»“æœ
print("æ€»å‘¨æœŸ:", result.total_cycles)
print("æµæ°´çº¿å»¶è¿Ÿ:", result.latency_cycles)
print("é¢ç§¯:", result.area_total)

print("åŠ¨æ€èƒ½é‡ (pJ):", result.energy_dyn_total * 1e12)
print("æ¼ç”µèƒ½é‡ (pJ):", result.energy_leak_total * 1e12)

print("å¹³å‡åŠ¨æ€åŠŸè€— (uW):", result.avg_power_dyn * 1e6)
print("å¹³å‡æ€»åŠŸè€— (uW):", result.avg_power_total * 1e6)

print("å­æ¨¡å—èƒ½é‡åˆ†è§£:", result.energy_dyn_breakdown)

2.5 æŸ¥çœ‹æµæ°´çº¿è¡Œä¸ºï¼ˆå¯é€‰ï¼‰
trace = mac.trace_pipeline_schedule(num_ops=8)
for row in trace:
    print(row)


è¾“å‡ºç¤ºä¾‹ï¼š

{'cycle': 0, 'stage0_valid': True,  'stage1_valid': False, 'stage2_valid': False}
{'cycle': 1, 'stage0_valid': True,  'stage1_valid': True,  'stage2_valid': False}
{'cycle': 2, 'stage0_valid': True,  'stage1_valid': True,  'stage2_valid': True}
...


å¯ç”¨äºç»˜åˆ¶ pipeline å¯è§†åŒ–å›¾æˆ–åˆ†æ CE stall æƒ…å†µã€‚

3. å‚æ•°é…ç½®ï¼ˆParameter Configurationï¼‰

MAC Simulator çš„é…ç½®åˆ†ä¸ºä¸‰ç±»ï¼š

3.1 æŠ€æœ¯å‚æ•°ï¼ˆMacTechParamsï¼‰

è¯¥ç±»å‚¨å­˜æ¥è‡ª DC çš„å·¥è‰ºç»“æœï¼š

MacTechParams(
    area_total=2979.51,     # å•é¢— MAC çš„é¢ç§¯
    p_dyn_total=60.58e-6,   # DC çš„åŠ¨æ€åŠŸè€—
    p_leak_total=47.87e-6,  # DC çš„æ¼ç”µåŠŸè€—
    clk_period=2e-9         # 2ns clock â†’ 500MHz
)


å¯é€šè¿‡ä»¥ä¸‹æ–¹å¼è¦†ç›–é»˜è®¤å€¼ï¼š

mac = CoordinatedSkipMacSimulator(
    tech=MacTechParams(area_total=3200)
)

3.2 å­æ¨¡å—åŠŸè€—æ¯”ä¾‹ï¼ˆMacBreakdownï¼‰

æ ¹æ® report_power -hier è‡ªåŠ¨æ‹†è§£æˆæ¨¡å—å æ¯”ï¼š

æ¨¡å—	é»˜è®¤å æ¯”
Sum Tree	42%
PP Generator	18%
Skip Detector	2%
Booth Encoder	2%
Other Logic	36%

å¯æ‰‹åŠ¨è°ƒæ•´ï¼š

breakdown = MacBreakdown(
    frac_sum_tree=0.45,
    frac_pp_generator=0.20,
    frac_skip_detector=0.02,
    frac_booth_encoder=0.02,
    frac_other_logic=0.31
)

3.3 æ´»è·ƒåº¦ç¨€ç–é…ç½®ï¼ˆMacActivityConfigï¼‰

ç”¨äºæ¨¡æ‹ŸçœŸå® workload ä¸‹ power scalingï¼š

MacActivityConfig(
    mac_active_ratio=0.4,      # æœ‰æ•ˆçš„æ—¶é’Ÿå‘¨æœŸæ¯”ä¾‹
    pp_activity_scale=0.6      # æ´»è·ƒå‘¨æœŸå†…ç¿»è½¬ç‡
)


å®ƒçš„ä½œç”¨ï¼š

æ¨¡æ‹Ÿ skip gatingï¼ˆæ´»è·ƒç‡ä¸‹é™ â†’ åŠ¨æ€èƒ½é‡ä¸‹é™ï¼‰

æ¨¡æ‹Ÿç¨€ç–æ¿€æ´»ï¼ˆç¿»è½¬ç‡ä¸‹é™ â†’ åŠ¨æ€èƒ½é‡ä¸‹é™ï¼‰

é€‚ç”¨äº Transformer çš„ FlashAttention / BFP ç¨€ç–è¡Œä¸º

4. è¾“å‡ºå†…å®¹è¯´æ˜ï¼ˆResult Fieldsï¼‰

ä»¿çœŸå™¨è¿”å› MacSimResult å¯¹è±¡ï¼Œå…¶ä¸­åŒ…å«ï¼š

å­—æ®µ	æ„ä¹‰
num_ops	æ‰§è¡Œçš„ MAC æ•°é‡
total_cycles	æ€»å‘¨æœŸæ•°ï¼ˆè‡ªåŠ¨åŠ  pipeline latencyï¼‰
latency_cycles	MAC pipeline çš„æ·±åº¦
area_total	é¢ç§¯ï¼ˆæ¥è‡ª DCï¼‰
energy_dyn_total	åŠ¨æ€èƒ½é‡ï¼ˆä¸ workload ç›¸å…³ï¼‰
energy_leak_total	æ¼ç”µèƒ½é‡ï¼ˆä¸å‘¨æœŸæ•°ç›¸å…³ï¼‰
energy_dyn_breakdown	æŒ‰å­æ¨¡å—åˆ†è§£çš„åŠ¨æ€èƒ½é‡
avg_power_dyn	å¹³å‡åŠ¨æ€åŠŸè€—
avg_power_total	æ€»åŠŸè€—ï¼ˆåŠ¨æ€ + æ¼ç”µï¼‰
5. ç¤ºä¾‹è¾“å‡ºï¼ˆçœŸå®è¿è¡Œç»“æœï¼‰
==== MAC ä»¿çœŸç»“æœ ====
è¾“å…¥ MAC æ¬¡æ•°: 1000
æ€»æ‹æ•°: 1002
æµæ°´çº¿å»¶è¿Ÿ(æ‹): 3
é¢ç§¯(çº¦): 2979.51
æ€»åŠ¨æ€èƒ½é‡ (pJ): 29.151
æ€»æ¼ç”µèƒ½é‡ (pJ): 95.935
å¹³å‡åŠ¨æ€åŠŸè€— (uW): 14.546
å¹³å‡æ€»åŠŸè€—   (uW): 62.418
åŠ¨æ€èƒ½é‡æŒ‰å­æ¨¡å—åˆ†è§£ (pJ):
   sum_tree:       12.244
   pp_generator:    5.247
   skip_detector:   0.583
   booth_encoder:   0.583
   other_logic:    10.495

6. é€‚ç”¨èŒƒå›´ï¼ˆUse Casesï¼‰

è¯¥æ¨¡æ‹Ÿå™¨å¯ç›´æ¥ç”¨äºï¼š

CEï¼ˆCompute Engineï¼‰ç³»ç»Ÿå»ºæ¨¡

PUï¼ˆProcessing Unitï¼‰èµ„æºè§„åˆ’

FlashAttention chunk å¤§å°ä¸å¸¦å®½æŠ˜ä¸­

FFN åˆ†å—è°ƒåº¦åˆ†æ

BFP Transformer çš„ç¨€ç–æ€§èƒ½è€—åˆ†æ

DFA Training çš„åå‘è·¯å¾„èƒ½è€—

å­¦æœ¯è®ºæ–‡æ€§èƒ½/åŠŸè€—è¯„ä¼°éƒ¨åˆ†

æ”¯æŒå¤šé¢— MAC å¹¶è¡Œï¼Œåªéœ€åœ¨ä¸Šå±‚å¾ªç¯è°ƒç”¨å³å¯ã€‚
